<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Gallery & Viewer</title>
    <!-- Load Tailwind CSS (CDN is fine for this environment) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Slate Background */
            color: #f3f4f6;
        }
        .container-card {
            background-color: #1f2937; /* Slightly lighter card background */
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.4);
            border: 1px solid #374151;
        }
        .btn-action {
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .delete-btn {
            background-color: #dc2626; /* Red-600 */
        }
        .delete-btn:hover {
            background-color: #b91c1c; /* Red-700 */
        }
        /* Style for link icon on hover */
        .link-icon {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .img-preview-cell:hover .link-icon {
            opacity: 1;
        }
        /* Custom scrollbar for the table container */
        #gallery-container::-webkit-scrollbar {
            height: 6px;
        }
        #gallery-container::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8 flex items-start justify-center">

    <div id="app-container" class="w-full max-w-6xl container-card rounded-xl p-6 md:p-10 mt-10">
        <!-- Initial loading message -->
        <div id="loading-initial" class="text-center p-8 text-gray-400">
             <svg class="animate-spin h-8 w-8 text-indigo-400 inline-block mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Initializing application and authenticating...</p>
        </div>
    </div>

    <!-- Hidden file input for selection -->
    <input type="file" id="file-input" accept="image/*" class="hidden">
    
    <!-- Custom Modal for Delete Confirmation -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm shadow-2xl border border-red-700">
            <h3 class="text-xl font-bold text-red-400 mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to permanently delete this image? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete" class="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-500 transition">Cancel</button>
                <button id="confirm-delete" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        // Fallback IDs are provided in case the variables are somehow undefined, though they shouldn't be.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-image-bin-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- GLOBAL STATE ---
        let db = null;
        let auth = null;
        let currentUserId = null;
        let selectedFile = null; 
        const MAX_FILE_SIZE_BYTES = 1000 * 1024; // ~1MB limit for Firestore Base64 encoding
        const MAX_IMAGE_DIMENSION = 1200; // Max width or height for resizing

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const fileInput = document.getElementById('file-input');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        let imageToDeleteId = null;

        // --- PATHS ---
        const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/images`;

        // --- UTILITIES ---

        /** Generates an absolute URL for sharing. */
        function getAbsoluteShareUrl(imageId) {
            // Get the base URL (e.g., https://user.github.io/repo/)
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
            
            // Ensures the path is always absolute, pointing back to the current file with the ID.
            return `${baseUrl}index.html?id=${imageId}`;
        }
        
        /** Shows a temporary message notification. */
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white font-semibold transform transition-transform duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        /** Copies text to the clipboard. */
        function copyToClipboard(text, successMessage) {
            try {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showNotification(successMessage);
            } catch (err) {
                console.error('Could not copy text: ', err);
                showNotification('Error: Failed to copy link to clipboard.', true);
            }
        }
        
        /** Converts a File object to a resized Base64 Data URL using the Canvas API. */
        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_IMAGE_DIMENSION) {
                                height *= MAX_IMAGE_DIMENSION / width;
                                width = MAX_IMAGE_DIMENSION;
                            }
                        } else {
                            if (height > MAX_IMAGE_DIMENSION) {
                                width *= MAX_IMAGE_DIMENSION / height;
                                height = MAX_IMAGE_DIMENSION;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Export as JPEG with compression quality 0.8 to reduce file size significantly
                        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(resizedBase64);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // --- ROUTING / VIEW CONTROLLER ---
        
        /** Determines which UI to show based on URL parameters. */
        function routeApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const imageId = urlParams.get('id');

            // Wait for auth to be ready before routing
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    if (imageId) {
                        renderViewerView(imageId);
                    } else {
                        renderGalleryView();
                        loadImagesFromFirestore();
                    }
                } else {
                    // This case is unlikely to be hit if sign-in is successful in initApp
                    console.log("Authentication state not ready yet.");
                }
            });
        }
        
        // --- GALLERY VIEW RENDERING (index.html mode) ---

        /** Renders the main gallery UI structure. */
        function renderGalleryView() {
            appContainer.innerHTML = `
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-extrabold text-indigo-400 mb-2">Image Gallery</h1>
                    <p class="text-gray-400">Upload your images, get a shareable link, and view the real-time history.</p>
                </div>

                <!-- UPLOAD SECTION -->
                <div class="mb-10 p-6 bg-gray-800 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Upload New Image</h2>
                    <div id="drop-zone" class="p-8 text-center border-2 border-dashed border-indigo-500 rounded-xl cursor-pointer hover:bg-gray-700 transition duration-300">
                        <svg class="mx-auto h-12 w-12 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8"></path></svg>
                        <p class="mt-2 text-sm text-gray-300"><span class="font-semibold text-indigo-400">Click to select image</span> or drag and drop</p>
                        <p class="text-xs text-gray-500 mt-1">Files over 1MB will be resized automatically.</p>
                    </div>
                    
                    <div id="upload-status-area" class="mt-4 hidden p-4 bg-gray-700 rounded-lg">
                        <p id="file-name-display" class="text-gray-300 font-medium truncate"></p>
                        <div id="upload-message" class="mt-2 text-sm text-yellow-300"></div>
                        <div class="flex mt-4 space-x-4">
                            <button id="upload-btn" class="btn-action btn-primary flex-1 py-2 text-white font-semibold rounded-lg disabled:opacity-50" disabled>
                                <i class="fas fa-cloud-upload-alt mr-2"></i> Upload & Generate Link
                            </button>
                            <button id="clear-btn" class="btn-action bg-gray-600 hover:bg-gray-500 py-2 px-4 text-white font-semibold rounded-lg">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- IMAGE TABLE -->
                <div class="mt-12">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 border-b border-indigo-500 pb-2">Image History</h2>
                    <p id="loading-status" class="text-gray-400 text-center p-4">Fetching history from Firestore...</p>
                    <div id="gallery-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700 rounded-xl overflow-hidden shadow-lg hidden" id="image-table">
                            <thead class="bg-indigo-600/70">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Preview</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Name</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider hidden md:table-cell">Size</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider hidden md:table-cell">Owner</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Uploaded At</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-gray-800 divide-y divide-gray-700" id="image-table-body">
                                <!-- Rows inserted here by loadImagesFromFirestore -->
                            </tbody>
                        </table>
                        <p id="empty-message" class="text-gray-500 text-center p-4 bg-gray-800 rounded-lg hidden">No images uploaded yet. Use the form above to get started!</p>
                    </div>
                </div>
            `;
            // Attach gallery event listeners after rendering
            attachGalleryListeners();
        }

        /** Renders a single row in the image history table. */
        function renderImageRow(image) {
            const isOwner = image.ownerId === currentUserId;
            const ownerDisplay = isOwner 
                ? `<span class="text-green-400 font-bold">You</span>`
                : `<span class="text-gray-400">${image.ownerId.substring(0, 8)}...</span>`;
                
            const sizeDisplay = (image.size / 1024).toFixed(2) + ' KB';
            const absoluteLink = getAbsoluteShareUrl(image.id);

            return `
                <tr data-id="${image.id}" class="hover:bg-gray-700 transition duration-150 relative">
                    <td class="img-preview-cell px-3 py-3">
                        <div class="relative w-12 h-12">
                            <img src="${image.base64Data}" alt="Thumbnail" class="w-full h-full object-cover rounded-md border border-gray-600">
                            <!-- Link Icon Overlay -->
                            <button onclick="event.stopPropagation(); copyToClipboard('${absoluteLink}', 'Absolute Share URL copied!');"
                                    class="link-icon absolute inset-0 flex items-center justify-center bg-black bg-opacity-60 rounded-md text-indigo-400 hover:text-white transition duration-200">
                                <i class="fas fa-link text-lg"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-3 py-3 text-sm font-medium text-gray-300 truncate max-w-[150px]">${image.fileName}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-400 hidden md:table-cell">${sizeDisplay}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm hidden md:table-cell">${ownerDisplay}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${image.timestamp}</td>
                    <td class="px-3 py-3 text-center whitespace-nowrap">
                        <div class="flex space-x-2 justify-center">
                            <!-- View Button (Always visible, opens in new tab) -->
                            <a href="${absoluteLink}" target="_blank" class="btn-action p-2 text-sm font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white transition duration-150 shadow-md">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <!-- Delete Button (Only visible for owner) -->
                            ${isOwner ? 
                                `<button data-id="${image.id}" class="delete-btn flex items-center justify-center space-x-1 p-2 text-sm font-semibold rounded-lg text-white transition duration-150 shadow-md">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>` : ''
                            }
                        </div>
                    </td>
                </tr>
            `;
        }

        // --- VIEWER VIEW RENDERING (index.html?id=ABC mode) ---

        /** Renders the single image viewer UI. */
        function renderViewerView(imageId) {
            appContainer.innerHTML = `
                <div class="w-full mx-auto text-center">
                    <!-- Image Container/Status Display -->
                    <div id="viewer-card" class="bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col items-center justify-center min-h-96 border border-indigo-700">
                        <h1 id="image-title" class="text-3xl font-extrabold text-indigo-400 mb-4">Loading Image...</h1>
                        <p id="image-details" class="text-gray-400 mb-6"></p>

                        <div id="loading-spinner" class="text-center">
                            <svg class="animate-spin h-8 w-8 text-indigo-400 inline-block mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-gray-400 mt-2">Fetching image data for ID: ${imageId}...</p>
                        </div>

                        <!-- Image display area -->
                        <div id="image-display-container" class="mt-4 hidden w-full">
                            <img id="shared-image" alt="Shared Image" class="w-full h-auto max-h-[80vh] object-contain rounded-lg shadow-lg mx-auto" style="min-height: 200px;">
                        </div>
                        
                        <!-- Error message area -->
                        <div id="error-message" class="mt-4 hidden text-red-400 font-medium"></div>

                    </div>
                    
                    <a href="index.html" class="mt-6 inline-block py-2 px-6 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-200">
                        ← Go Back to Gallery
                    </a>
                </div>
            `;
            // Attach viewer logic
            fetchImage(imageId);
        }

        /** Fetches and displays a single image in viewer mode. */
        async function fetchImage(imageId) {
            const imageTitleEl = document.getElementById('image-title');
            const imageDetailsEl = document.getElementById('image-details');
            const loadingSpinnerEl = document.getElementById('loading-spinner');
            const imageDisplayContainerEl = document.getElementById('image-display-container');
            const sharedImageEl = document.getElementById('shared-image');
            const errorMessageEl = document.getElementById('error-message');

            const displayError = (title, message) => {
                imageTitleEl.textContent = title;
                imageDetailsEl.textContent = '';
                loadingSpinnerEl.classList.add('hidden');
                errorMessageEl.textContent = message;
                errorMessageEl.classList.remove('hidden');
                imageDisplayContainerEl.classList.add('hidden');
            };

            try {
                // The current user must be authenticated (even anonymously) to satisfy security rules.
                if (!db) throw new Error("Database not initialized."); 
                
                const imageRef = doc(db, PUBLIC_COLLECTION_PATH, imageId);
                const docSnap = await getDoc(imageRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Display the image
                    imageTitleEl.textContent = data.fileName || "Shared Image";
                    imageDetailsEl.textContent = `Owner: ${data.ownerId.substring(0, 8)}... | Size: ${(data.size / 1024).toFixed(2)} KB | Uploaded: ${new Date(data.timestamp.seconds * 1000).toLocaleDateString()}`;
                    sharedImageEl.src = data.base64Data;
                    
                    // Show the image and hide loading/error
                    imageDisplayContainerEl.classList.remove('hidden');
                    loadingSpinnerEl.classList.add('hidden');

                } else {
                    displayError("Image Not Found", `The image with ID: "${imageId}" does not exist or has been deleted.`);
                }
                
            } catch (error) {
                console.error("Image Fetch Error:", error);
                displayError("Database Error", `Failed to retrieve data. This may be due to a permissions issue or network error.`);
            }
        }


        // --- FIREBASE DATA LOGIC (Gallery Mode) ---

        /** Loads real-time image data from Firestore. */
        function loadImagesFromFirestore() {
            if (!db) return;

            const loadingStatus = document.getElementById('loading-status');
            const imageTable = document.getElementById('image-table');
            const imageTableBody = document.getElementById('image-table-body');
            const emptyMessage = document.getElementById('empty-message');
            
            const imagesRef = collection(db, PUBLIC_COLLECTION_PATH);
            const q = imagesRef; 

            if (loadingStatus) loadingStatus.textContent = 'Loading history...';

            onSnapshot(q, (snapshot) => {
                const uploadedFiles = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    uploadedFiles.push({
                        id: doc.id,
                        fileName: data.fileName,
                        base64Data: data.base64Data,
                        size: data.size, // Size in bytes
                        timestamp: timestamp,
                        ownerId: data.ownerId 
                    });
                });
                
                // Sort by time (descending) in memory
                uploadedFiles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Render the table
                imageTableBody.innerHTML = uploadedFiles.map(image => renderImageRow(image)).join('');

                if (uploadedFiles.length > 0) {
                    imageTable.classList.remove('hidden');
                    if (loadingStatus) loadingStatus.classList.add('hidden');
                    emptyMessage.classList.add('hidden');
                } else {
                    imageTable.classList.add('hidden');
                    emptyMessage.classList.remove('hidden');
                }

            }, (error) => {
                console.error("Error listening to Firestore:", error);
                if (loadingStatus) loadingStatus.textContent = "Error fetching history: Data sync failed.";
            });
        }

        /** Saves the selected image data to Firestore. */
        async function saveImageToFirestore(name, base64Data) {
            if (!db || !currentUserId) {
                showNotification('Database not ready. Please wait.', true);
                return;
            }

            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = true;

            const sizeMatch = base64Data.match(/^data:image\/\w+;base64,(.*)/);
            const base64Content = sizeMatch ? sizeMatch[1] : '';
            const sizeInBytes = Math.ceil((base64Content.length * 3) / 4); 

            try {
                await addDoc(collection(db, PUBLIC_COLLECTION_PATH), {
                    fileName: name,
                    base64Data: base64Data, 
                    size: sizeInBytes,
                    timestamp: serverTimestamp(),
                    ownerId: currentUserId 
                });
                showNotification(`Image "${name}" uploaded and link generated!`);
                
                // Clear state after successful upload
                handleClear();
            } catch (error) {
                console.error("Error writing document:", error);
                showNotification(`Upload failed: ${error.message}`, true);
            } finally {
                uploadBtn.disabled = false;
            }
        }
        
        /** Deletes an image document from Firestore. */
        async function deleteImageFromFirestore(imageId) {
            if (!db || !currentUserId) {
                showNotification('Authentication required to delete.', true);
                return;
            }

            try {
                const docRef = doc(db, PUBLIC_COLLECTION_PATH, imageId);
                // The security rule check (ownerId == request.auth.uid) happens on the server.
                await deleteDoc(docRef);
                showNotification(`Image successfully deleted.`);
            } catch (error) {
                console.error("Deletion failed:", error);
                // A common failure here is due to the server-side security rule blocking non-owners.
                showNotification(`Deletion failed. You can only delete images you uploaded.`, true);
            }
        }

        // --- GALLERY EVENT HANDLERS ---
        
        /** Clears the selected file and resets the UI. */
        function handleClear() {
            selectedFile = null;
            fileInput.value = '';
            const uploadStatusArea = document.getElementById('upload-status-area');
            if (uploadStatusArea) uploadStatusArea.classList.add('hidden');
        }

        function attachGalleryListeners() {
            const dropZone = document.getElementById('drop-zone');
            const uploadBtn = document.getElementById('upload-btn');
            const clearBtn = document.getElementById('clear-btn');

            // --- File Selection Handler ---
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                handleFileSelection(file);
            };
            
            // --- Drop Zone Handlers ---
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            dropZone.addEventListener('drop', (e) => handleDrop(e), false);
            dropZone.onclick = () => fileInput.click();

            // --- Button Handlers ---
            if (uploadBtn) {
                uploadBtn.onclick = async () => {
                    if (selectedFile) {
                        const base64Data = await processImageForUpload(selectedFile);
                        if (base64Data) {
                            await saveImageToFirestore(selectedFile.name, base64Data);
                        }
                    } else {
                        showNotification('Please select an image first.', true);
                    }
                };
            }
            if (clearBtn) {
                clearBtn.onclick = handleClear;
            }

            // --- Table Delete Listener ---
            appContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    imageToDeleteId = e.target.getAttribute('data-id');
                    deleteModal.style.display = 'flex';
                }
            });
            
            // --- Modal Listeners ---
            confirmDeleteBtn.onclick = () => {
                if (imageToDeleteId) {
                    deleteImageFromFirestore(imageToDeleteId);
                }
                deleteModal.style.display = 'none';
                imageToDeleteId = null;
            };
            cancelDeleteBtn.onclick = () => {
                deleteModal.style.display = 'none';
                imageToDeleteId = null;
            };
        }
        
        /** Handles file drop logic. */
        function handleDrop(e) {
            e.preventDefault();
            const dt = e.dataTransfer;
            if (dt.files.length > 0) {
                handleFileSelection(dt.files[0]);
            }
        }
        
        /** Common file validation and preview logic. */
        function handleFileSelection(file) {
            if (!file || !file.type.startsWith('image/')) {
                showNotification('Invalid file type. Please select an image.', true);
                handleClear();
                return;
            }
            selectedFile = file;
            
            const uploadStatusArea = document.getElementById('upload-status-area');
            const fileNameDisplay = document.getElementById('file-name-display');
            const uploadBtn = document.getElementById('upload-btn');
            const uploadMessage = document.getElementById('upload-message');
            
            fileNameDisplay.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            uploadMessage.textContent = file.size > MAX_FILE_SIZE_BYTES ? 'File is large. It will be resized automatically on upload.' : 'File size is acceptable.';
            uploadStatusArea.classList.remove('hidden');
            uploadBtn.disabled = false;
        }

        /** Handles resizing and conversion logic before saving. */
        async function processImageForUpload(file) {
            const uploadMessage = document.getElementById('upload-message');
            const sizeInBytes = file.size;
            
            if (sizeInBytes > MAX_FILE_SIZE_BYTES) {
                uploadMessage.textContent = 'Resizing image... Please wait.';
                const base64Data = await resizeImage(file);
                const newSizeMatch = base64Data.match(/^data:image\/\w+;base64,(.*)/);
                const newBase64Content = newSizeMatch ? newSizeMatch[1] : '';
                const newSizeInBytes = Math.ceil((newBase64Content.length * 3) / 4); 
                
                if (newSizeInBytes > MAX_FILE_SIZE_BYTES) {
                    showNotification(`Resized file is still too large (${(newSizeInBytes / 1024).toFixed(1)} KB). Try a smaller image.`, true);
                    return null;
                }
                uploadMessage.textContent = `Resizing successful! New size: ${(newSizeInBytes / 1024).toFixed(1)} KB.`;
                return base64Data;
                
            } else {
                uploadMessage.textContent = 'Preparing file for upload...';
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }
        }

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // --- INITIALIZATION ---

        async function initApp() {
            const loadingInitial = document.getElementById('loading-initial');
            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                
                // CRITICAL FIX: The check that prevents the Firebase crash
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Missing Firebase configuration. The 'projectId' is required to connect to the database. Please ensure your environment is correctly configured.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user (using custom token if available, otherwise anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth to be fully ready before routing the app
                routeApp();
            } catch (error) {
                console.error("Fatal Error initializing Firebase:", error);
                // Display the error clearly to the user instead of just crashing
                appContainer.innerHTML = `
                    <div class="p-8 text-center bg-red-900/30 rounded-xl border border-red-700">
                        <h2 class="text-2xl text-red-400 font-bold mb-3">Initialization Error</h2>
                        <p class="text-red-300">The application could not start because it failed to initialize the database.</p>
                        <p class="text-sm text-red-200 mt-2">${error.message}</p>
                    </div>
                `;
            } finally {
                if (loadingInitial) loadingInitial.classList.add('hidden');
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>
