<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Token Admin Image Uploader</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Combined Firebase Imports for Firestore ONLY (Auth is removed) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, 
            query, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose combined Firebase objects globally
        window.firebase = {
            initializeApp, getFirestore, collection, addDoc, onSnapshot, 
            query, serverTimestamp, setLogLevel
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Theme & Layout --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Slate-800 equivalent */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .app-container {
            background-color: #374151; /* Slate-700 */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }
        
        /* --- Login Specific Styles --- */
        .input-field {
            background-color: #1f2937; /* Slate-800 */
            color: #d1d5db; /* Gray-300 */
            border: 1px solid #4b5563; /* Gray-600 */
        }
        .input-field:focus {
            border-color: #6366f1; /* Indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
        
        /* --- Uploader Specific Styles --- */
        #drop-zone {
            transition: all 0.3s ease-in-out;
            border-style: dashed;
            background-color: #374151; /* Slate-700 */
        }
        #drop-zone.hover {
            border-color: #6366f1; /* Indigo-500 */
            background-color: #4b5563; /* Slate-600 */
            transform: scale(1.02);
        }
        
        /* --- Shared Button Styles --- */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 4px 10px -2px rgba(79, 70, 229, 0.4);
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px -3px rgba(79, 70, 229, 0.6);
        }
        .btn-secondary {
            background-color: #374151; /* Slate-700 */
            color: #d1d5db; /* Gray-300 */
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Slate-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.3);
        }
        /* Custom scrollbar for the table container */
        #uploaded-images-list::-webkit-scrollbar {
            height: 6px;
        }
        #uploaded-images-list::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <div id="login-view" class="w-full max-w-md p-8 rounded-xl app-container mx-4">
        <h1 class="text-3xl font-bold text-gray-100 text-center mb-2">Token Access Panel</h1>
        <p class="text-gray-400 text-center mb-8">Enter one of the required access codes to proceed.</p>

        <div id="login-message-box" class="p-4 rounded-lg border-l-4 border-gray-600 bg-gray-700 text-gray-300 hidden mb-6"></div>

        <form id="login-form" class="space-y-4">
            <!-- Single Code Input -->
            <div>
                <label for="login-single-code" class="block text-sm font-medium text-gray-300 mb-1">Access Code</label>
                <input type="text" id="login-single-code" name="code" required class="w-full px-4 py-2 rounded-lg input-field focus:outline-none" placeholder="Enter code here...">
            </div>

            <div class="pt-4">
                <button type="submit" id="login-btn" class="btn btn-primary w-full text-white font-semibold py-2.5 rounded-lg">
                    Verify Code
                </button>
            </div>
        </form>
    </div>

    <div id="uploader-view" class="w-full max-w-4xl p-6 md:p-10 rounded-xl app-container hidden mt-10">

        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-gray-100">Image Upload Bin <span class="text-indigo-400">2.0</span></h1>
            <button id="logout-btn" class="btn btn-secondary px-4 py-2 text-sm">
                Log Out
            </button>
        </div>
        <p class="text-gray-400 mb-8">Upload images and manage your data links. User ID: <span id="current-user-id" class="font-mono text-xs text-indigo-300">N/A</span></p>

        <!-- Hidden File Input -->
        <input type="file" id="file-input" accept="image/*" class="hidden">

        <!-- Drop Zone & File Selection -->
        <div id="drop-zone" class="p-8 text-center border-2 border-indigo-400 rounded-xl cursor-pointer hover:shadow-lg transition duration-300"
             onclick="document.getElementById('file-input').click()">
            <svg class="mx-auto h-12 w-12 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8"></path></svg>
            <p class="mt-2 text-sm text-gray-300"><span class="font-semibold text-indigo-400">Click to select file</span> or drag and drop</p>
            <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 1MB | Preview is Local</p>
        </div>

        <!-- Preview Container -->
        <div id="preview-section" class="mt-8 hidden p-4 bg-gray-700 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Live Preview</h2>
            <div id="image-preview-container" class="relative w-full h-72 bg-gray-900 rounded-lg overflow-hidden border border-gray-600 flex items-center justify-center">
                <!-- Image will be inserted here -->
            </div>
            <p id="file-name" class="text-sm text-gray-300 mt-3 font-medium truncate"></p>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="upload-button" class="btn btn-primary px-8 py-3 rounded-lg shadow-md disabled:opacity-50" disabled>
                Upload Image (Save to Firestore)
            </button>
            <button id="link-button" class="btn btn-secondary px-8 py-3 rounded-lg shadow-md disabled:opacity-50" disabled>
                Generate Data URL Link
            </button>
        </div>

        <!-- Status Message Box -->
        <div id="uploader-message-box" class="mt-8 p-4 rounded-lg border-l-4 border-gray-600 bg-gray-700 text-gray-300 hidden">
            <!-- Messages appear here -->
        </div>

        <!-- Uploaded Images List (Firestore Data) -->
        <div id="list-section" class="mt-12">
            <h2 class="text-xl font-bold text-gray-100 mb-4 border-b border-indigo-500 pb-2">Uploaded Images History</h2>
            <div id="uploaded-images-list" class="overflow-x-auto">
                <!-- Image list table will be rendered here -->
            </div>
            <p id="loading-status" class="text-gray-400 mt-4 text-center">Awaiting Token Verification...</p>
        </div>
    </div>

    <script>
        const {
            initializeApp, getFirestore, collection, addDoc, onSnapshot, 
            query, serverTimestamp, setLogLevel
        } = window.firebase;

        // =========================================================================================
        // --- HARDCODED CREDENTIALS & CONFIGURATION ---
        // ONLY ONE OF THESE THREE VALUES will grant access when entered into the single field.
        const VALID_TOKEN = ["3008", "AMRS", "101111000000"];
        
        // Fixed IDs for Firestore data path when logged in
        const CUSTOM_APP_ID = 'image-uploader-46f04'; // Using your Project ID as App ID
        const CUSTOM_USER_ID = 'HARDCODED_ADMIN_USER';

        // --- FIREBASE CONFIGURATION (YOUR LIVE KEYS) ---
        // Only apiKey and projectId are strictly necessary for Firestore.
        const firebaseConfig = {
            apiKey: "AIzaSyBJELImxh2a5nx85UCHIxHgiD-H-v8LsxE", // YOUR KEY
            projectId: "image-uploader-46f04", // YOUR PROJECT ID
        };
        // ----------------------------------------------
        
        // This is used for the database path
        const appId = firebaseConfig.projectId || CUSTOM_APP_ID;
        // ------------------------------------------------------------------

        // --- Global State ---
        let db = null;
        let userId = null;
        let unsubscribeSnapshot = null; // To clean up Firestore listener

        // --- UI Elements ---
        const loginView = document.getElementById('login-view');
        const uploaderView = document.getElementById('uploader-view');
        const loginForm = document.getElementById('login-form');
        // Single Input Element
        const loginSingleCodeInput = document.getElementById('login-single-code'); 
        
        const loginBtn = document.getElementById('login-btn');
        const loginMessageBox = document.getElementById('login-message-box');
        
        const logoutBtn = document.getElementById('logout-btn');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const previewSection = document.getElementById('preview-section');
        const previewContainer = document.getElementById('image-preview-container');
        const fileNameDisplay = document.getElementById('file-name');
        const uploadButton = document.getElementById('upload-button');
        const linkButton = document.getElementById('link-button');
        const uploaderMessageBox = document.getElementById('uploader-message-box');
        const imageListContainer = document.getElementById('uploaded-images-list');
        const loadingStatus = document.getElementById('loading-status');
        
        let selectedFile = null;
        let uploadedImageUrl = null;

        // --- Utility Functions ---

        function toggleView(isAuthenticated) {
            if (isAuthenticated) {
                loginView.classList.add('hidden');
                uploaderView.classList.remove('hidden');
            } else {
                uploaderView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        }

        /** Displays a message in the status box. */
        function showMessage(type, message, target, link = null) {
            const box = target === 'login' ? loginMessageBox : uploaderMessageBox;
            let border, bg, text;
            switch(type) {
                case 'error':
                    border = 'border-red-500'; bg = 'bg-red-900/40'; text = 'text-red-300'; break;
                case 'success':
                    border = 'border-green-500'; bg = 'bg-green-900/40'; text = 'text-green-300'; break;
                case 'loading':
                    border = 'border-indigo-500'; bg = 'bg-indigo-900/40'; text = 'text-indigo-300'; break;
                default: // info
                    border = 'border-gray-500'; bg = 'bg-gray-700'; text = 'text-gray-300';
            }

            let linkHtml = link ? `<a href="#" onclick="window.copyLink('${link}', 'Current Selection')" class="text-indigo-400 underline hover:text-indigo-300 break-all mt-2 block">Data URL (Click to copy)</a>` : '';

            box.className = `p-4 rounded-lg border-l-4 ${border} ${bg} ${text} mb-6`;
            box.innerHTML = `<p>${message}</p>${linkHtml}`;
            box.classList.remove('hidden');
        }
        
        // Expose copyLink to global scope for use in onclick
        window.copyLink = (link, name) => {
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showMessage('success', `Data URL for "${name}" copied to clipboard!`, 'uploader');
        };

        // --- Firebase Initialization (Firestore only) ---

        function initFirebase() {
            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                showMessage('info', 'System ready. Enter codes to log in.', 'login');

                // Ensure initial view state is correct
                userId = null;
                toggleView(false); 
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage('error', 'Could not initialize Database services. Check console for details.', 'login');
            }
        }

        // --- Uploader Data Logic (Firestore) ---
        
        function loadImagesFromFirestore() {
            if (!db || !userId) return;

            // Firestore Path: /artifacts/{appId}/users/{userId}/uploaded_images
            // Data is stored under the fixed CUSTOM_USER_ID, accessible only to this app.
            const collectionPath = `artifacts/${appId}/users/${userId}/uploaded_images`;
            const imagesRef = collection(db, collectionPath);
            const q = imagesRef;

            loadingStatus.textContent = 'Loading history...';

            // Stop any previous listener
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); 
            }

            // Subscribe to real-time changes
            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const uploadedFiles = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Fallback for timestamp
                    const timestamp = data.timestamp && data.timestamp.seconds 
                        ? new Date(data.timestamp.seconds * 1000).toLocaleString() 
                        : 'N/A';
                        
                    uploadedFiles.push({
                        id: doc.id,
                        name: data.name,
                        url: data.url,
                        time: timestamp
                    });
                });
                uploadedFiles.sort((a, b) => new Date(b.time) - new Date(a.time));
                renderImageList(uploadedFiles);
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                loadingStatus.textContent = "Error fetching history: Data sync failed.";
            });
        }

        async function saveImageToFirestore(name, url) {
            if (!db || !userId) {
                showMessage('error', 'Database connection not ready. Please log in again.', 'uploader');
                return;
            }

            // The path ensures data is stored under the fixed custom admin ID
            const collectionPath = `artifacts/${appId}/users/${userId}/uploaded_images`;
            const imagesRef = collection(db, collectionPath);

            try {
                await addDoc(imagesRef, {
                    name: name,
                    url: url,
                    timestamp: serverTimestamp()
                });
                showMessage('success', `Image "${name}" successfully uploaded and saved to history!`, 'uploader');
            } catch (error) {
                console.error("Error writing document:", error);
                // Check if the error is due to large data (Firestore limit is 1MB per document)
                let errorMessage = error.message.includes('Value for argument "data" is not a valid Firestore document') 
                                 ? 'Upload failed: Data URL size exceeds Firestore document limit (1MB).' 
                                 : `Upload failed: ${error.message}`;
                showMessage('error', errorMessage, 'uploader');
            }
        }
        
        // --- Uploader UI Rendering ---
        
        function renderImageList(files) {
            loadingStatus.classList.add('hidden');
            if (files.length === 0) {
                imageListContainer.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-700 rounded-lg">No images uploaded yet. Upload your first image!</p>';
                return;
            }

            const tableHtml = `
                <table class="min-w-full divide-y divide-gray-700 rounded-xl overflow-hidden shadow-lg">
                    <thead class="bg-indigo-600/70">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider hidden md:table-cell">ID</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Image</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">File Name</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider hidden sm:table-cell">Time</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                        ${files.map(file => `
                            <tr class="hover:bg-gray-700 transition duration-150 cursor-pointer" onclick="copyLink('${file.url}', '${file.name}')">
                                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-400 hidden md:table-cell truncate">${file.id}</td>
                                <td class="px-3 py-3">
                                    <img src="${file.url}" alt="Thumbnail" class="w-10 h-10 object-cover rounded-md border border-gray-600">
                                </td>
                                <td class="px-3 py-3 text-sm font-medium text-gray-300 truncate max-w-xs sm:max-w-none">
                                    ${file.name}
                                    <span class="text-xs text-indigo-400 block mt-1">Click row to copy link</span>
                                </td>
                                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${file.time}</td>
                                <td class="px-3 py-3 text-center whitespace-nowrap">
                                    <button onclick="event.stopPropagation(); copyLink('${file.url}', '${file.name}')" class="text-indigo-400 hover:text-indigo-300 text-sm font-medium transition duration-150 p-1 rounded-md hover:bg-gray-600">
                                        Copy Link
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            imageListContainer.innerHTML = tableHtml;
        }

        // --- Event Listeners (Login) ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Get value from the single input field
            const inputToken = loginSingleCodeInput.value.trim();

            // Check if the input token is included in the array of valid tokens
            const isValid = VALID_TOKEN.includes(inputToken);

            loginBtn.disabled = true;
            loginBtn.textContent = 'Verifying...';

            if (isValid) {
                userId = CUSTOM_USER_ID;
                currentUserIdDisplay.textContent = userId;
                showMessage('success', 'Access granted! Loading upload history.', 'login');
                
                // Grant access and load data
                toggleView(true); // TRANSITIONS TO UPLOADER VIEW
                loginForm.reset(); // Clears input field for cleanup
                loadImagesFromFirestore();
                loginBtn.textContent = 'Access Granted';
            } else {
                showMessage('error', 'Invalid access code. Access denied.', 'login');
                loginBtn.textContent = 'Verify Code';
                // Small delay before enabling the button again for UX
                setTimeout(() => { loginBtn.disabled = false; }, 1000);
            }
        });

        logoutBtn.addEventListener('click', () => {
            // Simply clear the session state and return to login view
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); 
            }
            userId = null;
            selectedFile = null;
            uploadedImageUrl = null;
            imageListContainer.innerHTML = '';
            loadingStatus.textContent = 'Awaiting Token Verification...';
            toggleView(false);
            showMessage('info', 'Logged out successfully. Enter codes to re-access.', 'login');
            loginBtn.textContent = 'Verify Code';
            loginBtn.disabled = false;
        });

        // --- Combined Event Listeners (Uploader) ---

        function handleFile(file) {
            // Firestore documents are limited to 1MB. Data URLs for images are often larger.
            const MAX_SIZE_MB = 1; 
            const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;

            if (!file || !file.type.startsWith('image/') || file.size > MAX_SIZE_BYTES) {
                showMessage('error', `Invalid file (must be image < ${MAX_SIZE_MB}MB).`, 'uploader');
                selectedFile = null;
                uploadButton.disabled = linkButton.disabled = true;
                previewSection.classList.add('hidden');
                return;
            }

            selectedFile = file;
            fileNameDisplay.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            uploadButton.disabled = linkButton.disabled = false;

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageUrl = e.target.result;
                previewContainer.innerHTML = `<img src="${uploadedImageUrl}" alt="Image Preview" class="w-full h-full object-contain">`;
                previewSection.classList.remove('hidden');
                uploaderMessageBox.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        uploadButton.addEventListener('click', async () => {
            if (!uploadedImageUrl || !selectedFile) return;

            uploadButton.disabled = linkButton.disabled = true;
            showMessage('loading', `Uploading "${selectedFile.name}" and saving to history...`, 'uploader');

            await saveImageToFirestore(selectedFile.name, uploadedImageUrl);

            uploadButton.disabled = linkButton.disabled = false;
        });

        linkButton.addEventListener('click', () => {
            if (!uploadedImageUrl) return;
            showMessage('info', 'Data URL Generated for Current Selection.', 'uploader', uploadedImageUrl);
        });

        // Drag and Drop Logic
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults (e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.add('hover'), false); });
        ['dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.remove('hover'), false); });
        dropZone.addEventListener('drop', (e) => { handleFile(e.dataTransfer.files[0]); }, false);

        // --- Initialization ---
        window.onload = initFirebase;
    </script>

</body>
</html>
