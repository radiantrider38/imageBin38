<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Image Bin</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for image list */
        #image-list::-webkit-scrollbar {
            width: 8px;
        }
        #image-list::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
            üñºÔ∏è Collaborative Image Bin
        </h1>
        <p class="text-sm text-blue-600 mb-6 font-medium" id="user-info">
            Loading user...
        </p>

        <!-- Loading Indicator and Error Message -->
        <div id="status-message" class="mb-4 text-center py-2 text-sm font-semibold text-white rounded-lg hidden"></div>

        <!-- Image Upload Section -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 mb-8">
            <label for="image-upload" class="block text-lg font-medium text-gray-700 mb-3">Upload a Photo</label>
            <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100
                focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
            ">
            <div class="flex items-center mt-4">
                <input type="text" id="image-name" placeholder="Enter a name for the image"
                       class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <button id="upload-btn"
                        class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-r-lg hover:bg-blue-700 transition duration-150 disabled:opacity-50">
                    Save Image
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Note: Images are stored directly in Firestore as base64 strings. Keep file size small (&lt; 500KB) to avoid exceeding document limits and save bandwidth.</p>
        </div>

        <!-- Image Gallery -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Shared Images</h2>
        <div id="image-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-h-[60vh] overflow-y-auto p-2">
            <!-- Images will be inserted here -->
            <p id="no-images-msg" class="col-span-full text-center text-gray-500 italic">No images have been shared yet. Start uploading!</p>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & FIREBASE SETUP ---
        let db;
        let auth;
        let appId;
        let userId;

        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('image-upload');
        const nameInput = document.getElementById('image-name');
        const imageList = document.getElementById('image-list');
        const statusMessage = document.getElementById('status-message');
        const noImagesMsg = document.getElementById('no-images-msg');

        // Helper function to show notifications
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `mb-4 text-center py-2 text-sm font-semibold text-white rounded-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        // Helper function to convert File to Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function initFirebase() {
            setLogLevel('debug'); // Enable Firestore logging
            let firebaseConfig;
            
            // NOTE: Using a static App ID for external hosting consistency.
            const currentAppId = 'image-bin-github-app';

            try {
                // -----------------------------------------------------------------------------------
                // --- CRITICAL STEP FOR GITHUB/EXTERNAL HOSTING: CONFIGURATION SUPPLIED ---
                // This configuration connects the app to your Firebase Project: image-uploader-46f04
                // -----------------------------------------------------------------------------------
                firebaseConfig = {
                    apiKey: "AIzaSyBJELImxh2a5nx85UCHIxHgiD-H-v8LsxE",           
                    authDomain: "image-uploader-46f04.firebaseapp.com",  
                    projectId: "image-uploader-46f04",    
                    storageBucket: "image-uploader-46f04.firebasestorage.app",
                    messagingSenderId: "1046392282951",
                    appId: "1:1046392282951:web:ca8e9e14d6281f03bef662",
                    measurementId: "G-WX74X0NEGK"
                };
                
                appId = currentAppId;
                
                // Initialize Firebase App and Services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Setting persistence to Local Storage to maintain user session permanently.
                await setPersistence(auth, browserLocalPersistence);

                // Sign in anonymously for a permanent, simple user ID.
                await signInAnonymously(auth);

                // Get current user ID and update UI
                // Using crypto.randomUUID() as a final fallback if auth fails for some reason
                userId = auth.currentUser?.uid || crypto.randomUUID(); 
                document.getElementById('user-info').innerHTML = `Logged in as: <span class="font-mono text-xs bg-gray-100 p-1 rounded">${userId}</span> (App ID: ${appId})`;
                uploadBtn.disabled = false;
                showStatus('Firebase initialized and user authenticated!', false);

                // Start listening for images
                listenForImages();

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('user-info').textContent = `Authentication Failed! Cannot start app.`;
                uploadBtn.disabled = true;
                // Show a detailed error message on the screen
                showStatus(`Initialization Error: ${error.message}`, true);
            }
        }

        // --- FIRESTORE LOGIC ---

        // Collection path for public data: /artifacts/{appId}/public/data/images
        function getCollectionRef() {
            return collection(db, 'artifacts', appId, 'public', 'data', 'images');
        }

        async function handleImageUpload() {
            if (!db || !userId) {
                showStatus('System not ready. Please wait for initialization.', true);
                return;
            }

            const file = fileInput.files[0];
            const name = nameInput.value.trim();

            if (!file || !name) {
                showStatus('Please select an image and enter a name.', true);
                return;
            }

            // Check file size (approximate)
            if (file.size > 500 * 1024) { // 500 KB limit for demonstration
                showStatus('Image size is too large (>500KB). Please upload a smaller file.', true);
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            try {
                const base64Data = await fileToBase64(file);

                await addDoc(getCollectionRef(), {
                    name: name,
                    imageUrl: base64Data, // Storing base64 directly in Firestore (only for small images)
                    mimeType: file.type,
                    uploadedBy: userId,
                    createdAt: serverTimestamp()
                });

                showStatus(`Image "${name}" uploaded successfully!`);
                nameInput.value = '';
                fileInput.value = ''; // Clear file input
            } catch (e) {
                console.error("Error adding document: ", e);
                showStatus(`Failed to upload image: ${e.message}`, true);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Save Image';
            }
        }
        
        // New function to handle image deletion
        async function deleteImage(imageId, imageName, uploaderId) {
            if (uploaderId !== userId) {
                // This is a minimal check; Firestore security rules should handle the final authorization
                showStatus(`You can only delete images you uploaded!`, true);
                return;
            }
            
            // Use a custom modal or window.confirm() as a substitute for alert/confirm since we're in an isolated environment.
            const confirmed = window.confirm(`Are you sure you want to delete "${imageName}"?`);
            if (!confirmed) return;


            try {
                const imageDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'images', imageId);
                await deleteDoc(imageDocRef);
                showStatus(`Image "${imageName}" deleted successfully!`);
            } catch (e) {
                console.error("Error deleting document: ", e);
                showStatus(`Failed to delete image: ${e.message}`, true);
            }
        }

        function renderImages(images) {
            imageList.innerHTML = ''; // Clear current list

            if (images.length === 0) {
                noImagesMsg.classList.remove('hidden');
                return;
            } else {
                noImagesMsg.classList.add('hidden');
            }

            images.forEach(image => {
                const imageCard = document.createElement('div');
                imageCard.className = 'bg-white border border-gray-200 rounded-xl shadow-md overflow-hidden transition-all hover:shadow-lg flex flex-col relative';

                // Image Container
                const imgContainer = document.createElement('div');
                imgContainer.className = 'w-full h-40 bg-gray-100 overflow-hidden flex items-center justify-center';
                const img = document.createElement('img');
                img.src = image.imageUrl;
                img.alt = image.name;
                img.className = 'w-full h-full object-cover';
                // Fallback for failed image load
                img.onerror = () => {
                    img.alt = "Failed to load image.";
                    img.className = 'p-4 text-center text-gray-400 w-full h-full object-contain';
                    // Using a responsive placeholder image URL
                    img.src = `https://placehold.co/400x160/e5e7eb/6b7280?text=Load+Error`;
                };
                imgContainer.appendChild(img);
                imageCard.appendChild(imgContainer);

                // Content
                const content = document.createElement('div');
                content.className = 'p-4 flex-grow';

                const name = document.createElement('h3');
                name.textContent = image.name;
                name.className = 'text-lg font-semibold text-gray-800 truncate';
                content.appendChild(name);

                const uploader = document.createElement('p');
                uploader.textContent = `By: ${image.uploadedBy.substring(0, 8)}...`;
                uploader.className = 'text-xs text-gray-500 mt-1';
                content.appendChild(uploader);

                const date = document.createElement('p');
                // Format the timestamp if it exists
                if (image.createdAt && image.createdAt.seconds) {
                    const d = new Date(image.createdAt.seconds * 1000);
                    date.textContent = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                } else {
                    date.textContent = '...just now';
                }
                date.className = 'text-xs text-gray-500 mt-1';
                content.appendChild(date);
                
                imageCard.appendChild(content);

                // Delete Button (only visible if uploaded by current user)
                if (image.uploadedBy === userId) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = 'üóëÔ∏è'; // Trash icon
                    deleteBtn.className = 'absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full text-sm hover:bg-red-600 transition duration-150 shadow-md';
                    deleteBtn.title = 'Delete this image';
                    deleteBtn.onclick = () => deleteImage(image.id, image.name, image.uploadedBy);
                    imageCard.appendChild(deleteBtn);
                }

                imageList.appendChild(imageCard);
            });
        }

        function listenForImages() {
            // Sorting by timestamp to show latest first
            const q = query(getCollectionRef(), orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const images = [];
                snapshot.forEach((doc) => {
                    images.push({ id: doc.id, ...doc.data() });
                });
                renderImages(images);
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showStatus(`Real-time error: Could not fetch shared data. ${error.message}`, true);
            });
        }


        // --- EVENT LISTENERS & INITIALIZATION ---
        uploadBtn.addEventListener('click', handleImageUpload);
        uploadBtn.disabled = true; // Disable until Firebase is ready

        // Start the application setup
        window.addEventListener('load', initFirebase);

    </script>
</body>
</html>
